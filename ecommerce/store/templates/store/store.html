{% extends 'store/main.html' %}
{% block title %}Productos{% endblock title %}
{% load static %}
{% block content %}
    <div class="row">
        {# Barra lateral para categorías y subcategorías #}
        <div class="col-lg-3 col-md-4">
            <div class="box-element p-3 mb-4">
                <h4 class="mb-3">Categorías</h4>
                <ul class="list-group list-group-flush">
                    {# Enlace para ver todos los productos #}
                    <li class="list-group-item {% if not selected_category %}active{% endif %}">
                        <a href="{% url 'store' %}" class="text-decoration-none text-dark">
                            Todos los Productos
                        </a>
                    </li>
                    {% for cat in categories %}
                        <li class="list-group-item {% if selected_category and selected_category.slug == cat.slug %}active{% endif %}">
                            <a href="{% url 'products_by_category' cat.slug %}" class="text-decoration-none text-dark">
                                {{ cat.name }}
                            </a>
                            {# Mostrar subcategorías si esta categoría está seleccionada o si hay subcategorías globales (opcional) #}
                            {% if selected_category and selected_category.slug == cat.slug and subcategories %}
                                <ul class="list-group list-group-flush mt-2">
                                    {% for subcat in subcategories %}
                                        <li class="list-group-item list-group-item-action {% if selected_subcategory and selected_subcategory.slug == subcat.slug %}active{% endif %}">
                                            <a href="{% url 'products_by_subcategory' cat.slug subcat.slug %}" class="text-decoration-none text-dark">
                                                - {{ subcat.name }}
                                            </a>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>

            {# --- NUEVA SECCIÓN DE PROMOCIONES --- #}
            {% if promotions %}
                <div class="box-element p-3 mb-4 promotion-section">
                    <h4 class="mb-3">Promociones Especiales</h4>
                    {% for promo in promotions %}
                        <div class="promotion-card mb-3">
                            {% if promo.imageURL %}
                                <a href="{{ promo.url_destino|default:'#' }}" {% if promo.url_destino %}target="_blank"{% endif %}>
                                    <img src="{{ promo.imageURL }}" alt="{{ promo.titulo }}" class="img-fluid mb-2">
                                </a>
                            {% endif %}
                            <h5 class="promo-title">{{ promo.titulo }}</h5>
                            <p class="promo-message">{{ promo.mensaje }}</p>
                            {% if promo.url_destino %}
                                <a href="{{ promo.url_destino }}" class="btn btn-sm btn-primary promo-btn" {% if promo.url_destino %}target="_blank"{% endif %}>Ver Oferta</a>
                            {% endif %}
                        </div>
                        {% if not forloop.last %}<hr class="my-3">{% endif %} {# Separador entre promos #}
                    {% endfor %}
                </div>
            {% endif %}
            {# ------------------------------------- #}
        </div>

        {# Contenido principal para productos #}
        <div class="col-lg-9 col-md-8">
            <div class="row">
                {% for product in products %}
                    <div class="col-lg-3 col-md-6 col-sm-6 mb-4">
                        <div class="box-element product-item">
                            {# Enlaza la imagen a la página de detalle del producto #}
                            <a href="{% url 'product_detail' product.slug %}">
                                <img class="thumbnail" src="{{ product.imageURL }}">
                            </a>
                            <div class="product-info">
                                {# Enlaza el nombre del producto a la página de detalle #}
                                <h6><strong><a href="{% url 'product_detail' product.slug %}" class="text-dark">{{ product.name }}</a></strong></h6>
                                <hr>
                                <h4 style="display: inline-block; float: right"><strong>€ {{ product.price|floatformat:2 }}</strong></h4>
                                <button data-product="{{ product.id }}" data-action="add" class="btn btn-outline-secondary add-btn update-cart">Añadir al Carrito</button>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="col-12 text-center mt-5">
                        <p class="lead">No hay productos disponibles en esta sección.</p>
                        <a href="{% url 'store' %}" class="btn btn-primary mt-3">Ver todos los productos</a>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock content %}